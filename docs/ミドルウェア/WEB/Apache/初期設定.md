## インストール

```bash
yum -y install httpd
```

### HTTPS を使用する場合

```bash
yum -y install mod_ssl
```

## VirtualHost の設定例
### HTTP

```conf
<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot /var/www/example.com/html/
    CustomLog /var/log/httpd/example.com_access.log combined
    ErrorLog /var/log/httpd/example.com_error.log

    <Directory /var/www/example.com/html/>
        Options +FollowSymLinks -Indexes
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

### HTTPS

```conf
<VirtualHost *:443>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot /var/www/example.com/html/
    CustomLog /var/log/httpd/example.com_ssl_access.log combined
    ErrorLog /var/log/httpd/example.com_ssl_error.log

    SSLEngine on
    SSLCertificateFile /etc/httpd/ssl/example.com.crt
    SSLCertificateKeyFile /etc/httpd/ssl/example.com.key
    SSLCertificateChainFile /etc/httpd/ssl/example.com.ca

    <Directory /var/www/example.com/html/>
        Options +FollowSymLinks -Indexes
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

## チューニング

- /etc/httpd/conf.d/99-custom.conf

### バージョンを表示しない

```conf
ServerTokens Prod
```

### 上位にロードバランサー等があり、X-Forwarded-ForにGIPを入れたい場合

```conf
RemoteIPHeader X-Forwarded-For

<IfModule log_config_module>
    LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%a %l %u %t \"%r\" %>s %b" common

    <IfModule logio_module>
      LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>
</IfModule>
```

## その他
### 不要なconfの無効化

```bash
mkdir /etc/httpd/conf.d/disabled
mv /etc/httpd/conf.d/autoindex.conf /etc/httpd/conf.d/disabled/
mv /etc/httpd/conf.d/userdir.conf /etc/httpd/conf.d/disabled/
mv /etc/httpd/conf.d/welcome.conf /etc/httpd/conf.d/disabled/
```

### Apache の書き込みにグループ権限を付与する場合

```bash
systemctl edit httpd
```

```conf
[Service]
UMask=002
```

## リダイレクト関連
### HTTPSリダイレクト
#### 上位にロードバランサーがない場合

```conf
# HTTP to HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^ https://example.com%{REQUEST_URI} [L,R=301]
```

#### 上位にロードバランサーがある場合

```conf
# HTTP to HTTPS
RewriteEngine On
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)?$ https://example.com%{REQUEST_URI} [L,R=301]
```

### wwwありなしの統一化
#### www なしに統一

```conf
# Redirect to not WWW
RewriteEngine On
RewriteCond %{HTTP_HOST} ^www\.example\.com$ [NC]
RewriteRule ^ https://example.com%{REQUEST_URI} [L,R=301]
```

#### www ありに統一

```conf
# Redirect to WWW
RewriteEngine On
RewriteCond %{HTTP_HOST} ^example\.com$ [NC]
RewriteRule ^ https://www.example.com%{REQUEST_URI} [L,R=301]
```