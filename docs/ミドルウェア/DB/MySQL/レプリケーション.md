## 目的
MySQL 8.0.17 で導入された CLONE プラグインを使用して、 InnoDB ストレージエンジン専用のレプリケーション構成を行う。

## 事前準備
### マスターサーバ
- /etc/my.cnf.d/replication.cnf

```conf
[mysqld]
server-id = 1
log-bin = mysql-bin
```

```bash
systemctl restart mysqld
```

### ユーザーの作成とプラグインのインストール

```sql
-- レプリケーション用ユーザー作成（任意のパスワードを設定）
CREATE USER 'repl_user'@'%' IDENTIFIED BY 'PASSWORD';
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';

-- クローン用ユーザー作成（任意のパスワードを設定）
CREATE USER 'clone_user'@'%' IDENTIFIED BY 'PASSWORD';
GRANT BACKUP_ADMIN ON *.* TO 'clone_user'@'%';

-- プラグインのインストール
INSTALL PLUGIN clone SONAME 'mysql_clone.so';
```

### レプリカサーバ
- /etc/my.cnf.d/replication.cnf

```conf
[mysqld]
server-id = 2
log-bin = mysql-bin
relay-log = node01-relay-bin
relay-log-index = node01-relay-bin
```

```bash
systemctl restart mysqld
```

### ユーザーの作成とプラグインのインストール

```sql
-- クローン用ユーザー作成（任意のパスワードを設定）
CREATE USER 'clone_user'@'%' IDENTIFIED BY 'PASSWORD';
GRANT CLONE_ADMIN ON *.* TO 'clone_user'@'%';

-- プラグインのインストール
INSTALL PLUGIN clone SONAME 'mysql_clone.so';
```

## レプリケーションの実行
### レプリカサーバ

```sql
-- MASTER の IP を指定
SET GLOBAL clone_valid_donor_list = '192.168.1.1:3306';

-- クローンの実行
CLONE INSTANCE FROM clone_user@192.168.1.1:3306 IDENTIFIED BY 'PASSWORD';

-- クローンの進行状況を確認（STATE が Completed になればOK）
SELECT ID, STATE, SOURCE, DESTINATION, BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;
```

### クローン完了時の表示例

```sql
+------+-----------+------------------+----------------+------------------+-----------------+
| ID   | STATE     | SOURCE           | DESTINATION    | BINLOG_FILE      | BINLOG_POSITION |
+------+-----------+------------------+----------------+------------------+-----------------+
|    1 | Completed | 192.168.1.1:3306 | LOCAL INSTANCE | mysql-bin.000001 |         257794  |
+------+-----------+------------------+----------------+------------------+-----------------+
```

## レプリケーションの開始

```sql
-- レプリケーション元を設定（上記のBINLOG情報を利用）
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.1',
  SOURCE_LOG_FILE = 'mysql-bin.000001',
  SOURCE_LOG_POS = 257794;

-- レプリケーションユーザーで接続を開始
START REPLICA USER = 'repl_user' PASSWORD = 'PASSWORD';

-- ステータス確認
SHOW REPLICA STATUS\G
```